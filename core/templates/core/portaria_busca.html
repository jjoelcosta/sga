{% extends "base.html" %}
{% load static %}

{% block title %}Portaria — Consulta de Acessos | SGA{% endblock %}

{% block content %}
<div class="row">
  <div class="col-12">
    <h1 class="h3 mb-3">Consulta de Acesso — Portaria</h1>
  </div>

  <!-- Form de busca -->
  <div class="col-12">
    <form class="row g-2 mb-3" method="get" action="{% url 'portaria' %}">
      <div class="col-md-6 col-lg-5">
        <input
          type="text"
          name="q"
          class="form-control"
          placeholder="Digite CPF (11 dígitos), Placa (ex: ABC1D23) ou Nome"
          value="{{ termo|default:'' }}"
          autofocus
        />
      </div>
      <div class="col-auto">
        <button class="btn btn-primary" type="submit">Buscar</button>
      </div>
      <div class="col-auto">
        <a class="btn btn-outline-secondary" href="{% url 'portaria' %}">Limpar</a>
      </div>
      <div class="col-auto">
        <a class="btn btn-outline-dark" href="" onclick="location.reload(); return false;">Atualizar</a>
      </div>
    </form>
  </div>

  <!-- Mensagens de ajuda -->
  <div class="col-12">
    <div class="alert alert-info py-2">
      Dica: digite a <strong>placa</strong> para consulta mais rápida. Também aceita <strong>CPF</strong> (11 dígitos) ou <strong>nome</strong>.
    </div>
  </div>

  <!-- Resultados -->
  <div class="col-12">
    {% if termo and resultados %}
      <div class="card">
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-striped table-hover mb-0 align-middle">
              <thead class="table-light">
                <tr>
                  <th>Nome</th>
                  <th>CPF</th>
                  <th>Empresa</th>
                  <th>Placa</th>
                  <th>Local</th>
                  <th>Período</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                {% for r in resultados %}
                  {% with ini=r.data_acesso_inicio fim=r.data_acesso_fim %}
                  <tr>
                    <td>{{ r.colaborador.nome }}</td>
                    <td>{{ r.colaborador.cpf }}</td>
                    <td>{{ r.colaborador.empresa.nome }}</td>
                    <td>
                      {% if r.veiculo %}
                        {{ r.veiculo.placa }}
                      {% else %}
                        <span class="text-muted">—</span>
                      {% endif %}
                    </td>
                    <td>{{ r.local }}</td>
                    <td>
                      {{ ini|date:"Y-m-d" }} — {{ fim|date:"Y-m-d" }}
                      {% if hoje >= ini and hoje <= fim %}
                        <span class="badge bg-success ms-1">Hoje válido</span>
                      {% else %}
                        <span class="badge bg-secondary ms-1">Fora da janela</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if r.status == "LIBERADO" %}
                        <span class="badge bg-success">LIBERADO</span>
                      {% elif r.status == "BLOQUEADO" %}
                        <span class="badge bg-danger">BLOQUEADO</span>
                      {% else %}
                        <span class="badge bg-warning text-dark">{{ r.status }}</span>
                      {% endif %}
                    </td>
                  </tr>
                  {% endwith %}
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    {% elif termo %}
      <div class="alert alert-warning">
        Nenhum resultado para <strong>{{ termo }}</strong>.
      </div>
    {% else %}
      <div class="alert alert-secondary">
        Faça uma busca para começar.
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}
